<!DOCTYPE html>
<html>
  <head>
    <title>Capture Photo</title>
	<link rel="stylesheet" type="text/css" href="css/index.css">
	<link href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.1/dojox/mobile/themes/iphone/iphone.css"
            rel="stylesheet"></link>
   
   <script src="phonegap.js"></script>
   <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.8.1/dojo/dojo.js"
    data-dojo-config="async:true"></script>
     <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    
	
	
	

    <script type="text/javascript" charset="utf-8">

    var pictureSource;   // picture source
    var destinationType; // sets the format of returned value
        
    // Wait for Cordova to connect with the device
    //
    document.addEventListener("deviceready",onDeviceReady,false);

    // Cordova is ready to be used!
    //
    function onDeviceReady() {
    alert("onDeviceReady"); 
    
    document.addEventListener( "touchstart", function(e){ onStart(e); }, false );
			function onStart ( touchEvent ) {
			  if( navigator.userAgent.match(/Android/i) ) {
			    touchEvent.preventDefault();
			  }
			}
			
			
        pictureSource=navigator.camera.PictureSourceType;
        destinationType=navigator.camera.DestinationType;
           
        	$('#eatFood').click(function() {
            alert("Hello! I am an alert box!");                    
   			capturePhoto();
   			showDatePicker();
   		
			});

		$('#showMyFood').click(function() {
   			
   			showDiary();
   		
			});
			
			
        
        
 if (navigator.userAgent.toLowerCase().indexOf("android") > -1) {

 //    $(".box").bind("mousedown", function () {
  $(".box").bind("touchstart", function (event) {
 
         $(this).addClass("fake-active");
//     }).bind("mouseup", function () {
     }).bind("touchend", function (event) {

         $(this).removeClass("fake-active");
     });
     
 }
        
        // Removed touchstart fix and put in JS fiddle JS cell to test
    }

//called when filesystem is loaded
 


    // Called when a photo is successfully retrieved
    //
    var finalImageData;
    function onPhotoDataSuccess(imageData) {
      // Uncomment to view the base64 encoded image data
      // console.log(imageData);
finalImageData = imageData;
      // Get image handle
    
       window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFileSystemSuccess, fail);
  
      
      
    }

    // Called when a photo is successfully retrieved
    //
    function onPhotoURISuccess(imageURI) {
      // Uncomment to view the image file URI 
      // console.log(imageURI);

      // Get image handle
      //
      var largeImage = document.getElementById('largeImage');

      // Unhide image elements
      //
      largeImage.style.display = 'block';

      // Show the captured photo
      // The inline CSS rules are used to resize the image
      //
      largeImage.src = imageURI;
    }

	function onFileSystemSuccess(fileSystem) {
    fileSystem.root.getDirectory("FoodDiary", {create: true, exclusive: false}, getDirSuccess, fail);
}

function onFileSystemSuccessB(fileSystem) {
    fileSystem.root.getDirectory("FoodDiary", {create: true, exclusive: false}, getDirSuccess3, fail);
}

	function onFileSystemSuccessF(fileSystem) {

   
  fileSystem.root.getDirectory("FoodDiary", {create: true, exclusive: false}, getDirSuccess2, fail);
       
       }

function getDirSuccess2(dirEntry){

    var value = window.localStorage.getItem("numOfPics");
         
    if(value==null){
    window.localStorage.setItem("numOfPics", "1");
    value = window.localStorage.getItem("numOfPics");
    }
    
    else {
    value ++;
    window.localStorage.setItem("numOfPics",value);
    value = window.localStorage.getItem("numOfPics");
    }
 
    
    
    var day = new Date().getDate();
    var month = new Date().getMonth();
    var year = new Date().getFullYear();
    
    var name = day.toString() +month.toString() + year.toString()+ value+".fooddiary";
    

    dirEntry.getFile(name, {create: true, exclusive: false}, gotFileEntry, fail);
    

}

function getDirSuccess3(dirEntry) {
    // Get a directory reader
    var directoryReader = dirEntry.createReader();

    // Get a list of all the entries in the directory
    directoryReader.readEntries(readerSuccess2,fail);
}

function getDirSuccess(dirEntry) {
    // Get a directory reader
    var directoryReader = dirEntry.createReader();

    // Get a list of all the entries in the directory
    directoryReader.readEntries(readerSuccess,fail);
}

function readerSuccess(entries) {
    addPhoto();
}

function readerSuccess2(entries) {
    var i;
var date = "INVALID";
require(["dijit/registry"], function(registry){
    date = registry.byId("datePicker").get("value");
});




var split = date.split("-");


var newDate = split[2]+parseInt(split[1]-1,10)+split[0];


    var div = document.getElementById("MealGallery");
      div.innerHTML = '';

    for (i=0; i<entries.length; i++) {
        // Assuming everything in the Music directory is an mp3, go nuts
        // otherwise check entries[i].name to see if it ends with .mp3
        if(entries[i].name.indexOf(newDate) !== -1){
        //this is found ;)
       	 
            var reader = new FileReader();
            
        reader.onloadend = function(evt) {
            console.log("Read as text");
            
         
            
 		   var img = new Image();
 		   img.src = "data:image/jpeg;base64,"+evt.target.result;
    		img.height=200;
    		img.width=200;
    	  
    	               div.appendChild(img);	
        
        };
        
       reader.readAsText(entries[i]);

 		
        }
      
        
    }
    
}

    // A button will call this function
    //
    function capturePhoto() {
      // Take picture using device camera and retrieve image as base64-encoded string
      navigator.camera.getPicture(onPhotoDataSuccess, onFail, { quality: 50,
        destinationType: destinationType.DATA_URL });
    }

    // A button will call this function
    //
    function capturePhotoEdit() {
      // Take picture using device camera, allow edit, and retrieve image as base64-encoded string  
      navigator.camera.getPicture(onPhotoDataSuccess, onFail, { quality: 20, allowEdit: true,
        destinationType: destinationType.DATA_URL });
    }

    // A button will call this function
    //
    function getPhoto(source) {
      // Retrieve image file location from specified source
      navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 50, 
        destinationType: destinationType.FILE_URI,
        sourceType: source });
    }

    // Called if something bad happens.
    // 
    function onFail(message) {
      alert('Failed because: ' + message);
    }
    
 function fail(error) {
 alert(error.code);
        console.log(error.code);
    }    
    
    function addPhoto(){
 
 		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFileSystemSuccessF, fail);
  
 	
    }
    
    
   
    function gotFileEntry(fileEntry) {
        fileEntry.createWriter(gotFileWriter, fail);
    }

    function gotFileWriter(writer) {
        writer.onwriteend = function(evt) {
           
           };
         
    
                writer.write(finalImageData);
                
        
    }
    
    
    
    function showDiary(){
    var storage = window.localStorage;
   
    //get date from dojo object
  
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFileSystemSuccessB, fail);
  
    
    
    }

    </script>
  </head>
  <body>
  
   <div id="main" data-dojo-type="dojox/mobile/SwapView" >  
  <h1>Food Diary</h1>
  
	<p id="speechbubble" class="speech-bubble">hey hey hey</p>
  <div id="eatFood" class="box">
  <p>Eat some food</p>
  </div>
  
  
  <br />
  <br />
  <p> Swipe right to left to see your current food diary! </p>
  <br />  	
  	</div>


 <div id="diary" data-dojo-type="dojox/mobile/SwapView">  
 
 <div id="diaryPage" data-dojo-type="dojox/mobile/ScrollableView">
	<h1>My Diary</h1>
	
  	<div id="datePicker" data-dojo-type="dojox/mobile/SpinWheelDatePicker"></div>
<br />

<br />
<div id="showMyFood" class="box"><p>Show my food</div>
	

<br />

<div id="MealGallery">

</div>
  	
  	</div>
</div>



  <script type="text/javascript" charset="utf-8">
   require([
   			"dijit/registry",
   			"dojox/mobile/parser",
   			"dojox/mobile",
   			"dojo/dom",
   			"dojo/ready",
   			"dojox/mobile/compat",
   			"dojox/mobile/SpinWheelDatePicker",
   			"dojox/mobile/ScrollableView",
   			"dojox/mobile/View",
   			"dojox/mobile/SwapView"], function(registry,parser){
   				
   			parser.parse();
   			
   			gotoToday = function(){
   				registry.byId("datePicker").reset();
   				
   			}
   			
   			
   			});
   			
   			
   		


  </script>
  

  </body>
</html>
