<html>
    <head>
      
        
   
    </head>
    
    <body>
        <div data-role="page" id="Home">
            <div data-role="content" id="datPick">
                <input type="date" id="datepicker" hidden="true"/>
                <br>
                <br>
                <a data-role="button" data-theme="d" href="" data-icon="check" data-iconpos="right" id="analyse">Analyse</a>
            </div>
            
            <div id="MealGallery" data-role="content" hidden="true">
                
                    
                        <a data-role="button" href="" data-icon="arrow-r" data-iconpos="right" id="breakfastb" class="buttons" value="breakfast">
                            Breakfast
                        </a>
                        <a data-role="button" href="" data-icon="arrow-r" data-iconpos="right" id="lunchb" class="buttons" value="lunch">
                            Lunch
                        </a>
                        <a data-role="button" href="" data-icon="arrow-r" data-iconpos="right" id="dinnerb" class="buttons" value="dinner">
                            Dinner
                        </a>
                <a data-role="button" href="" data-icon="arrow-r" data-iconpos="right" id="mostrecentb" class="buttons" value="mostrecent">
                    Most Recent
                </a>
                       
                    <div id="resultsForFood"></div>
                
                    <div id="resultsButton" hidden ="true">
                        <a data-role="button" href="" data-icon="arrow-r" data-iconpos="right" id="resultb" class="buttons" value="result">
                            Results
                        </a>
                    </div>
                
                <div id="resultsImage" hidden ="true">
                    <img src="img/results.jpg" alt="image">                    </div>
    
                </div>
                    
    
        
                            <script>
                        
                        var selDat;
                                var mostRecent = false;
                             
                         
                        
                                
                                $("#mostrecentb").click(function () {
                                                      
                                                       mostRecent = true;
                                                       showDiary();
                                                       $("#resultsButton").show(600);
                                                    });

                                
                                $("#resultb").click(function () {
                                                   $('#resultsForFood').hide();
                                                    $('#resultsButton').hide();
                                                   $('#resultsImage').show();
                                                   });
                                
                                
                                
                        $("#analyse").click(function () {
                                            var date = $('#datepicker').datepicker({ dateFormat: 'yy-mm-dd' }).val();
                                            if(date == null){
                                            
                                            
                                            }
                                            var pts=date.split("/");
                                            
                                            var day = pts[1];
                                            var month = pts[0];
                                            month --;
                                            if(month.length == 2){
                                            
                                            month = month.substring(1,2);
                                          
                                            }
                                            
                                            var year = pts[2];
                                            
                                            
//                                          alert("Day : " + day + " Month : " + month + " Year : " + year );
                                            $("#datPick").hide();
                                            $("#MealGallery").show();
                                            

                                            selDat = day+month+year;
                                    
                                            });
                    
                        
                        
                                function showDiary(){
                                    var storage = window.localStorage;
                                    //get date from dojo object
                                    
                                    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFileSystemSuccess, fail);
                                    
                                }
                                
                                function onFileSystemSuccess(fileSystem) {
                                    fileSystem.root.getDirectory("FoodDiary", {create: true, exclusive: false}, getDirSuccess, fail);
                                }
                                
                                function getDirSuccess(dirEntry) {
                                    // Get a directory reader
                                    var directoryReader = dirEntry.createReader();
                                    // Get a list of all the entries in the directory
                                    directoryReader.readEntries(showLastImage,fail);
                                    // Get a list of all the entries in the directory
                                    
                                }
                                
                                function showLastImage(entries){
                                    var div = document.getElementById("resultsForFood");
                                    div.innerHTML = '';
                                    
                                    if(entries.length > 1) var mostRecent = entries[0];
                                    
                                    alert("MostRecent " + mostRecent.name);
                                    var mstRecent = mostRecent.name.split("_");
                                    
                                    var today=new Date();
                                    
                                    
                                    alert("Year " + mstRecent[3] + " Month " + mstRecent[2]);
                                    var dt = new Date(mstRecent[3], mstRecent[2], mstRecent[1], mstRecent[0]);
                                    
                                    var diff = today - dt;
                                    alert("Diff " + diff);
                                    
                                    
//                                    for (i=0; i<entries.length; i++) {
//                                        alert("Img " + i + " : " + entries[i].name);
//                                        
//                                        var mstRecent = mostRecent.name.split("_");
//                                        var current = entries[i].name.split("_");
//                                        
////                                        The file name goes hr_day_month_year_value
//                                        
//                                        if(current[3] > mstRecent[3] &&
//                                           current[2] > mstRecent[2] &&
//                                           current[1] > mstRecent[1] &&
//                                           current[3] > mstRecent[3] &&
//                                        
//                                        
//                                    }
                                    
                                    
                                    
                                }
                                
                                
                                
                                
                                
                                
                                
                                function readerSuccess(entries) {
                                    
                                    // day.toString() +month.toString() + year.toString()+ value+".fooddiary";
                                    
                                    newDate = selDat;
                                    alert("Selected Date" + selDat);
                                    
//                                    alert("Showing Image " + evt.target.result);
                                    
                                    var div = document.getElementById("resultsForFood");
                                    div.innerHTML = '';
                                    if(entries.length > 1) var latestPicObj = entries[0];
                                    var latest = 0;
                                    var reader = new FileReader();
                                    for (i=0; i<entries.length; i++) {
                                        
                                        if(mostRecent){
                                            
                                            last = 0;
                                            latestPicObj = entries[last];
//                                            alert("Current image " + entries[i].name);
//                                            
//                                            var testedDate = entries[i].name.split("_");
//                                            var mostRec = latestPicObj.split("_");
//                                            
////                                            The file name goes hr_day_month_year_value
//                                            
//                                            if(testedDate[3] > mostRec[3] &&
//                                               testedDate[2] > mostRec[2] &&
//                                               testedDate[1] > mostRec[1] &&
//                                               testedDate[0] > mostRec[0]){
//                                            
////                                            if(entries[i].name.split("2013")[1].split(".")[0]> latest){
//                                            
//                                                latestPicObj = entries[i];
                                        
                                            
//                                            if(i == entries.length -1){
                                                    
                                                    
                                                    reader.onloadend = function(evt) {
                                                        console.log("Read as text");
                                                        
//                                                        alert("displaying image" + evt.target.result);
                                                        
                                                        var img = new Image();
                                                        img.src = "data:image/jpeg;base64,"+evt.target.result;
                                                        img.height=200;
                                                        img.width=200;
                                                        div.appendChild(img);
                                                    };
                                                        reader.readAsText(entries[i]);
                                                
//                                            }
                                            
                                        }else{
                                            
                                            
                                            
                                            if(entries[i].name.indexOf(newDate) !== -1){
                                                //this is found ;)
                                                var reader = new FileReader();
                                                
                                                reader.onloadend = function(evt) {
                                                    console.log("Read as text");
                                                    
                                                    
                                                    var img = new Image();
                                                    img.src = "data:image/jpeg;base64,"+evt.target.result;
                                                    img.height=200;
                                                    img.width=200;
                                                    div.appendChild(img);
                                                    //                                        div.show();
                                                    
                                                };
                                                reader.readAsText(entries[i]);
                                            }
                                        }
                                    }
                                }
                                
                        
                        </script>
                    
                    
                  
                  
                    <footer>
                        <div data-role="footer" data-id="foo1" data-position="fixed">
                            <div data-role="navbar">
                                <ul>
                                    <li><a href="index.html">Home</a></li>
                                    <li><a href="javascript:capturePhoto();">Camera</a></li>
                                    <li><a href="diary.html">Diary</a></li>
                                    <li><a href="about.html">About</a></li>
                                </ul>
                            </div><!-- /navbar -->
                        </div><!-- /footer -->
                    </footer>
            </body>
            </html>
            
