<html>
    <head>
      
        
   
    </head>
    
    <body>
        <div data-role="page" id="Home">
            <div data-role="content" id="datPick">
                <input type="date" id="datepicker" hidden="true"/>
                <br>
                <br>
                <a data-role="button" data-theme="d" href="" data-icon="check" data-iconpos="right" id="analyse">Breakdown</a>
            </div>
            
            <div id="MealGallery" data-role="content" hidden="true">
                
                    
                        <a data-role="button" href="" data-icon="arrow-r" data-iconpos="right" id="breakfastb" class="buttons" value="breakfast">
                            Breakfast
                        </a>
                        <a data-role="button" href="" data-icon="arrow-r" data-iconpos="right" id="lunchb" class="buttons" value="lunch">
                            Lunch
                        </a>
                        <a data-role="button" href="" data-icon="arrow-r" data-iconpos="right" id="dinnerb" class="buttons" value="dinner">
                            Dinner
                        </a>
                <a data-role="button" href="" data-icon="arrow-r" data-iconpos="right" id="mostrecentb" class="buttons" value="mostrecent">
                    Most Recent
                </a>
                       
                    <div id="resultsForFood"></div>
                
                    <div id="resultsButton" hidden ="true">
                        <a data-role="button" href="" data-icon="arrow-r" data-iconpos="right" id="resultb" class="buttons" value="result">
                            Results
                        </a>
                    </div>
                
                <div id="resultsImage" hidden ="true">
                    <img src="img/results.jpg" alt="image">                    </div>
    
                </div>
                    
    
        
                            <script>
                        
                                var selDat;
                                var MEAL;
                                var MOSTRECENT = 0;
                                var BREAKFAST = 1;
                                var LUNCH = 2;
                                var DINNER = 3;
                                
                                
                             
                         
                        
                                
                                $("#mostrecentb").click(function () {
                                                      
                                                      
                                                       showDiary(MOSTRECENT);
                                                       $("#resultsButton").show(600);
                                                    });
                                
                                $("#lunchb").click(function () {
                                                        
                                                        
                                                        showDiary(LUNCH);
                                                        $("#resultsButton").show(600);
                                                        });
                                
                                $("#dinnerb").click(function () {
                                                       
                                                       
                                                       showDiary(DINNER);
                                                       $("#resultsButton").show(600);
                                                       });
                                
                                $("#breakfastb").click(function () {
                                                       
                                                       
                                                       showDiary(BREAKFAST);
                                                       $("#resultsButton").show(600);
                                                       });
                                
                                

                                
                                $("#resultb").click(function () {
                                                   $('#resultsForFood').hide();
                                                    $('#resultsButton').hide();
                                                   $('#resultsImage').show();
                                                   });
                                
                                
                                
                                $("#analyse").click(function () {
                                                    var date = $('#datepicker').datepicker({ dateFormat: 'yy-mm-dd' }).val();
                                                    if(date == null){
                                                    
                                                    
                                                    }
                                                    var pts=date.split("/");
                                                    
                                                    var day = pts[1];
                                                    var month = pts[0];
                                                    month --;
                                                    if(month.length == 2){
                                                    
                                                    month = month.substring(1,2);
                                                    
                                                    }
                                                    
                                                    var year = pts[2];
                                                    
                                                    
                                                    //alert("Day : " + day + " Month : " + month + " Year : " + year );
                                                    $("#datPick").hide();
                                                    $("#MealGallery").show();
                                                    
                                                    
                                                    //selDat = day+month+year;
                                                    selDat = new Date(year,month,day);
                                                    
                                                    });
                    
                        
                        
                                function showDiary(usrOption){
                                    var storage = window.localStorage;
                                     MEAL = usrOption;
                                    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFileSystemReadSuccess, fail);
                                    
                                }
                                
                                function onFileSystemReadSuccess(fileSystem) {
                                    fileSystem.root.getDirectory("FoodDiary", {create: true, exclusive: false}, getDirReadSuccess, fail);
                                }
                                
                                function getDirReadSuccess(dirEntry) {
                                    // Get a directory reader
                                    var directoryReader = dirEntry.createReader();
                                    // Get a list of all the entries in the directory
                                    directoryReader.readEntries(showImages,fail);
                                    // Get a list of all the entries in the directory
                                    
                                }
                                
                                function showImages(entries){
                                    
                                    if(isNaN(selDat)) selDat = new Date();
                                    
                                    var div = document.getElementById("resultsForFood");
                                    $('#resultsForFood').empty();
                                    
                                    
                                    var reader = new FileReader();
                                    
                                    
                                    if(MEAL == MOSTRECENT){
                                        
                                        
                                        
                                        if(entries.length > 1) {
                                            
                                            var mostRecent = entries[0];
                                            
                                            var mstRecent = mostRecent.name.split("_");
                                            var today=new Date();
                                            var dt = new Date(mstRecent[3], mstRecent[2], mstRecent[1], mstRecent[0]);
                                            var diff = today - dt;
                                            
                                            
                                            for (i = 0; i<entries.length; i++) {
                                                
                                                tstDat = entries[i].name.split("_");
                                                //
                                                tmpDate = new Date(tstDat[3], tstDat[2], tstDat[1], tstDat[0]);
                                                //
                                                tstDiff = today - tmpDate;
                                                
                                                //                                            alert("tstDiff " + tstDiff + " ,oldDiff " + diff);
                                                
                                                
                                                if(tstDiff <= diff){
                                                    mostRecent = entries[i];
                                                    diff = tstDiff;
                                                }
                                            }
                                            
                                            
                                            
                                            
                                            
                                            
                                            reader.onloadend = function(evt) {
                                                console.log("Read as text");
                                                
                                                
                                                var img = new Image();
                                                img.src = "data:image/jpeg;base64,"+evt.target.result;
                                                img.height=200;
                                                img.width=200;
                                                div.appendChild(img);
                                                
                                            };
                                            reader.readAsText(mostRecent);
                                            
                                        }
                                        
                                    }
                                    else {
                                        
//                                        alert("Either breakfast, lunch or dinner");
                                        
                                        if(entries.length > 1) {
                                            
                                            //                                            Get all of todays images
                                            var todaysImages = [];
                                            for (i = 0; i<entries.length; i++) {
                                                
                                                //                                                alert("entres : " + i + " , " + entries[i].name);
                                                tstDat = entries[i].name.split("_");
                                                tmpDate = new Date(tstDat[3], tstDat[2], tstDat[1], tstDat[0]);
                                                
                                                
                                                if( tmpDate.getFullYear() == selDat.getFullYear() &&
                                                   tmpDate.getMonth() == selDat.getMonth() &&
                                                   tmpDate.getDate() == selDat.getDate() ){
                                                    
                                                    todaysImages.push(entries[i]);
                                                }
                                                
                                                
                                                
                                            }
//                                            alert("No images today : " + todaysImages.length);
                                            
                                            var imagesToShow = [];
                                            
//                                            alert("MEAL" + MEAL);
                                            for(j = 0; j < todaysImages.length; j++){
                                                
                                                todayTstDat = todaysImages[j].name.split("_");
                                                tmpTodayDate = new Date(todayTstDat[3], todayTstDat[2], todayTstDat[1], todayTstDat[0]);
                                                
                                                
                                                
                                                switch(MEAL){
                                                    
                                                    case BREAKFAST :
                                                        if(tmpTodayDate.getHours() <= 11) imagesToShow.push(todaysImages[j]);
                                                        break;
                                                    
                                                    case LUNCH :
                                                    if(tmpTodayDate.getHours() > 11 && tmpTodayDate.getHours() <= 16){
                                                        alert("Lunch condition met");
                                                        alert("todayImage " + todaysImages[j].name + ", Hours : " + tmpTodayDate.getHours());
                                                        imagesToShow.push(todaysImages[j]);
                                                    }
                                                        break;
                                                    
                                                    case DINNER : 
                                                    if(tmpTodayDate.getHours() > 16){
                                                        imagesToShow.push(todaysImages[j]);
                                                    }
                                                        break;
                                                }
                                                
                                                
                                                
                                            }
                                                                                        
                                            var readers = [];
                                            alert("Images for selected time " + imagesToShow.length);
                                            for(k = 0; k < imagesToShow.length; k++){
                                                
                                                readers.push(new FileReader());
                                                
                                                readers[k].onloadend = function(evt) {
                                                    console.log("Read as text");
                                                    
                                                    
                                                    var img = new Image();
                                                    img.src = "data:image/jpeg;base64,"+evt.target.result;
                                                    img.height=200;
                                                    img.width=200;
                                                    div.appendChild(img);
                                                                                                       
                                                };

                                                
                                                
//                                                alert("Img " + imagesToShow[k].name);
                                                readers[k].readAsText(imagesToShow[k]);
//                                                reader.readAsText(imagesToShow[1]);
                                            }
                                        }
                                    }
                                }
                                
                                    
                        
                                
                                
                        
                        </script>
                    
                    
                  
                  
                    <footer>
                        <div data-role="footer" data-id="foo1" data-position="fixed">
                            <div data-role="navbar">
                                <ul>
                                    <li><a href="index.html">Home</a></li>
                                    <li><a href="javascript:capturePhoto();">Camera</a></li>
                                    <li><a href="diary.html">Diary</a></li>
                                    <li><a href="about.html">About</a></li>
                                </ul>
                            </div><!-- /navbar -->
                        </div><!-- /footer -->
                    </footer>
            </body>
            </html>
            
